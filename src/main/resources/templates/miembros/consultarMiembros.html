<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Miembros</title>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/style/notification.css}">
    <link rel="stylesheet" th:href="@{/style/jefesStyle.css}">
    <script th:src="@{/js/notification.js}"></script>
</head>
<body>
<!-- Botón hamburguesa para móviles -->
<button class="sidebar-toggle" id="sidebarToggle">
    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>
</button>

<!-- Overlay para fondos oscuros al abrir sidebar en móvil -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div th:include="admin/template_admin.html::header"></div>


<!-- Contenido principal -->
<main>
    <!-- Aquí va el contenido de la página -->

    <div class="container">

        <div class="header">
            <h1 class="encabezado">Miembros Registrados</h1>
            <p class="description">Desde aquí puedes consultar, modificar y gestionar el estado de los miembros del
                grupo.</p>
        </div>


        <div id="actividadesSection" class="activities-container">
            <div class="header-row"></div>

            <div class="divider-line"></div>

            <div class="activities-container">
                <div class="header-row">
                    <div class="left-section">
                        <div class="tab-container">
                            <a href="?tab=activos" class="tab" th:classappend="${tab == 'activos' ? 'active' : ''}">Activos</a>
                            <a href="?tab=inactivos" class="tab" th:classappend="${tab == 'inactivos' ? 'active' : ''}">Inactivos</a>
                        </div>


                        <a th:href="@{/registrar}" class="create-miembro-btn">
                            <span>Agregar Miembro</span>
                            <img th:src="@{/img/plus.svg}" alt="Arrow" width="16" height="16">
                        </a>

                    </div>

                    <div class="search-container" style="margin-right: 55px;">
                        <input type="text" class="filter-search" placeholder="Ingrese el nombre...">
                        <button class="search-btn">
                            <div class="icon-placeholder search-icon">
                                <img th:src="@{/img/cancelFiltro.svg}" alt="Search" width="16" height="16">
                            </div>
                        </button>
                    </div>
                </div>
            </div>

        </div>


        <div class="table-responsive">
            <table>
                <thead>
                <tr>
                    <th class="nombre-col">Nombre</th>
                    <th class="docu-col">Documento</th>
                    <th class="rama-col">Rama</th>
                    <th class="docu-col">Nombre Contacto</th>
                    <th class="rama-col">Teléfono Contacto</th>
                    <th class="acc-col">Accion</th>
                </tr>
                </thead>
                <tbody id="tablaMiembros">
                <tr th:each="miembro : ${miembros}">
                    <td>
                        <div class="user-container">
                            <img th:src="@{/img/miembro.svg}" alt="Profile" class="profile-img">
                            <span th:text="${miembro.primerNombre+ ' '+miembro.segundoNombre+' '+miembro.primerApellido+
                            ' '+miembro.segundoApellido}">Nombre del miembro</span>
                        </div>
                    </td>
                    <td th:text="${miembro.tipoDeDocumento + '.' + miembro.numeroDeDocumento}">Documento</td>
                    <td>
                        <span th:class="'rama-badge ' + ${miembro.rama}" th:text="${miembro.rama}">Rama</span>
                    </td>
                    <td style="text-align: center">
                        <span th:text="${(miembro.responsable.nombres != null and miembro.responsable.apellidos != null) ? miembro.responsable.nombres + ' ' + miembro.responsable.apellidos : 'No registrado'}">Nombre Contacto</span>
                    </td>
                    <td style="text-align: center">
                    <span th:text="(${miembro.getResponsable().getTelefono()} == 0) ? 'No registrado' : ${miembro.getResponsable().getTelefono()}">
                        Teléfono Contacto</span>
                    </td>


                    <td class="action-col">
                        <div class="dropdown-container">
                            <button class="expand-btn">
                                <div class="dots-container">
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                </div>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="dropdown-icon" width="16" height="16"
                                         viewBox="0 0 16 16" fill="none">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                              d="M15 8C15 9.85652 14.2625 11.637 12.9497 12.9497C11.637 14.2625 9.85652 15 8 15C6.14348 15 4.36301 14.2625 3.05025 12.9497C1.7375 11.637 1 9.85652 1 8C1 6.14348 1.7375 4.36301 3.05025 3.05025C4.36301 1.7375 6.14348 1 8 1C9.85652 1 11.637 1.7375 12.9497 3.05025C14.2625 4.36301 15 6.14348 15 8ZM10 6C10 6.53043 9.78929 7.03914 9.41421 7.41421C9.03914 7.78929 8.53043 8 8 8C7.46957 8 6.96086 7.78929 6.58579 7.41421C6.21071 7.03914 6 6.53043 6 6C6 5.46957 6.21071 4.96086 6.58579 4.58579C6.96086 4.21071 7.46957 4 8 4C8.53043 4 9.03914 4.21071 9.41421 4.58579C9.78929 4.96086 10 5.46957 10 6ZM8 9C6.175 9 4.578 9.977 3.705 11.437C4.21992 12.0814 4.87345 12.6016 5.61703 12.9587C6.3606 13.3159 7.1751 13.5009 8 13.5C8.82473 13.5007 9.63904 13.3157 10.3824 12.9585C11.1258 12.6014 11.7792 12.0813 12.294 11.437C11.8506 10.6937 11.2217 10.0783 10.469 9.65112C9.71628 9.22392 8.8655 8.99956 8 9Z"
                                              fill="#919191"/>
                                    </svg>
                                    <span>Ver Perfil</span>
                                </div>
                                <div class="dropdown-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="dropdown-icon" width="16" height="16"
                                         viewBox="0 0 16 16" fill="none">
                                        <path d="M13.488 2.51311C13.3255 2.35059 13.1326 2.22167 12.9202 2.13372C12.7079 2.04576 12.4803 2.00049 12.2505 2.00049C12.0207 2.00049 11.7931 2.04576 11.5807 2.13372C11.3684 2.22167 11.1755 2.35059 11.013 2.51311L6.74999 6.77411C6.49469 7.02944 6.29217 7.33254 6.15399 7.66611L5.30599 9.71311C5.24918 9.85017 5.23431 10.001 5.26324 10.1465C5.29217 10.292 5.3636 10.4257 5.46851 10.5306C5.57342 10.6355 5.70708 10.7069 5.85259 10.7359C5.99811 10.7648 6.14893 10.7499 6.28599 10.6931L8.33299 9.84511C8.66656 9.70693 8.96966 9.50441 9.22499 9.24911L13.486 4.98711C13.8139 4.65896 13.9981 4.21403 13.9981 3.75011C13.9981 3.2862 13.8139 2.84127 13.486 2.51311H13.488Z"
                                              fill="#919191"/>
                                        <path d="M4.75 3.5C4.06 3.5 3.5 4.06 3.5 4.75V11.25C3.5 11.94 4.06 12.5 4.75 12.5H11.25C11.94 12.5 12.5 11.94 12.5 11.25V9C12.5 8.80109 12.579 8.61032 12.7197 8.46967C12.8603 8.32902 13.0511 8.25 13.25 8.25C13.4489 8.25 13.6397 8.32902 13.7803 8.46967C13.921 8.61032 14 8.80109 14 9V11.25C14 11.9793 13.7103 12.6788 13.1945 13.1945C12.6788 13.7103 11.9793 14 11.25 14H4.75C4.02065 14 3.32118 13.7103 2.80546 13.1945C2.28973 12.6788 2 11.9793 2 11.25V4.75C2 4.02065 2.28973 3.32118 2.80546 2.80546C3.32118 2.28973 4.02065 2 4.75 2H7C7.19891 2 7.38968 2.07902 7.53033 2.21967C7.67098 2.36032 7.75 2.55109 7.75 2.75C7.75 2.94891 7.67098 3.13968 7.53033 3.28033C7.38968 3.42098 7.19891 3.5 7 3.5H4.75Z"
                                              fill="#919191"/>
                                    </svg>
                                    <a th:href="@{'/miembros/modificarMiembro/' + ${miembro.userEntity.id} + '?origen=miembro'}">
                                        <span>Modificar</span>
                                    </a>

                                </div>
                                <div class="dropdown-item">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="dropdown-icon" width="13" height="13"
                                         viewBox="0 0 13 13" fill="none">
                                        <g clip-path="url(#clip0_69_607)">
                                            <path d="M2.84375 2.70825L10.4271 10.2916" stroke="#909090"
                                                  stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                            <path d="M12.0521 6.49992C12.0521 3.50838 9.62693 1.08325 6.63542 1.08325C3.64387 1.08325 1.21875 3.50838 1.21875 6.49992C1.21875 9.49144 3.64387 11.9166 6.63542 11.9166C9.62693 11.9166 12.0521 9.49144 12.0521 6.49992Z"
                                                  stroke="#909090" stroke-width="1.5"/>
                                        </g>
                                        <defs>
                                            <clipPath id="clip0_69_607">
                                                <rect width="13" height="13" fill="white"/>
                                            </clipPath>
                                        </defs>
                                    </svg>
                                    <!-- Si el usuario está activo, muestra formulario para desactivar -->
                                    <form th:if="${miembro.userEntity.activo}" th:action="@{/usuarios/desactivar}" method="post" style="display:inline;">
                                        <input type="hidden" name="idUsuario" th:value="${miembro.userEntity.id}" />
                                        <input type="hidden" name="origen" th:value="${origen}" />
                                        <button type="submit" style="all:unset; cursor:pointer; color:inherit; font:inherit;">
                                            <span>Deshabilitar</span>
                                        </button>
                                    </form>

                                    <!-- Si el usuario está inactivo, muestra formulario para habilitar -->
                                    <form th:unless="${miembro.userEntity.activo}" th:action="@{/usuarios/habilitar}" method="post" style="display:inline;">
                                        <input type="hidden" name="idUsuario" th:value="${miembro.userEntity.id}" />
                                        <input type="hidden" name="origen" th:value="${origen}" />
                                        <button type="submit" style="all:unset; cursor:pointer; color:inherit; font:inherit;">
                                            <span>Habilitar</span>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>

            </table>
        </div>
    </div>

    <div class="pagination-container">
        <div class="pagination">
            <a class="pagination-btn" id="prevPage" style="display: none;">Anterior</a>
            <span class="pagination-info" id="pageInfo"></span>
            <a class="pagination-btn" id="nextPage" style="display: none;">Siguiente</a>
        </div>
    </div>

    <!-- Modal de Ver Perfil -->
    <div id="modal-verPerfil" class="modal">
        <div class="modal-content">
            <div class="modal-header">

                <div class="profile-header">
                    <img th:src="@{/img/miembro.svg}" alt="Eliminar" class="profile-image">
                    <div class="profile-info">
                        <h1 class="name-profile">Miguel Andres Marin Fernandez</h1>
                        <p class="email-profile">miguelito@gmail.com</p>
                        <p class="state-profile">Activo</p>
                    </div>
                </div>
            </div>
            <div class="section">
                <div class="info-grid1">
                    <div class="info-item">
                        <p class="info-label">Fecha Nacimiento</p>
                        <p class="info-value">11-12-2005</p>
                    </div>
                    <div class="info-item">
                        <p class="info-label">Documento</p>
                        <p class="info-value">CC.1112041392</p>
                    </div>
                    <div class="info-item">
                        <p class="info-label">Rama</p>
                        <p class="info-value">MANADA</p>
                    </div>
                </div>
            </div>

            <div class="divider"></div>

            <div class="section">
                <h2 class="section-title">Datos de Contacto</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <p class="info-label">Dirección Residencia</p>
                        <p class="info-value">Carrera 9 #36-12, Barrio San Fernando, Cali</p>
                    </div>

                    <div class="info-item">
                        <p class="info-label">Teléfono</p>
                        <p class="info-value">316-358-7463</p>
                    </div>
                </div>

            </div>

            <div class="divider"></div>


            <div class="modal-footer">
                <button class="modal-button cancel-button">Cerrar</button>
            </div>
        </div>
        <div class="modal-overlay"></div>
    </div>

    <div th:include="admin/template_admin.html::footer"></div>
</main>
<script>
    const itemsPerPage = 5; // Número de elementos por página
    let currentPage = 1; // Página actual
    const items = document.querySelectorAll('#tablaMiembros tr'); // Todos los elementos de la tabla
    const totalItems = items.length; // Total de elementos
    const totalPages = Math.ceil(totalItems / itemsPerPage); // Total de páginas

    // Función para actualizar la tabla según la página actual
    function updateTable() {
        // Mostrar los elementos de la página actual
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        items.forEach((item, index) => {
            if (index >= start && index < end) {
                item.style.display = ''; // Mostrar el elemento
            } else {
                item.style.display = 'none'; // Ocultar el elemento
            }
        });

        // Actualizar la información de la página
        const pageInfoElement = document.getElementById('pageInfo');
        if (totalPages <= 1) {
            // Ocultar el mensaje de paginación cuando solo hay una página
            pageInfoElement.style.display = 'none';
        } else {
            pageInfoElement.style.display = '';
            pageInfoElement.textContent = `Página ${currentPage} de ${totalPages}`;
        }

        // Mostrar u ocultar los botones de "Anterior" y "Siguiente"
        document.getElementById('prevPage').style.display = currentPage > 1 ? '' : 'none';
        document.getElementById('nextPage').style.display = currentPage < totalPages ? '' : 'none';

        // Opcionalmente, ocultar también los botones de navegación cuando solo hay una página
        const paginationControls = document.getElementById('paginationControls');
        if (paginationControls) {
            paginationControls.style.display = totalPages <= 1 ? 'none' : '';
        }
    }

    // Manejar el botón "Anterior"
    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    });

    // Manejar el botón "Siguiente"
    document.getElementById('nextPage').addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            updateTable();
        }
    });

    // Inicializar la tabla
    updateTable();
</script>
<script>

    // Funciones para los modales
    document.addEventListener('DOMContentLoaded', function () {
        // --- FUNCIONES PARA MANIPULAR MODALES ---

        document.getElementById('modal-verPerfil').style.display = 'none';

        // Función para mostrar el modal
        function showModal() {
            document.getElementById('modal-verPerfil').style.display = 'block';
            document.body.style.overflow = 'hidden'; // Evita el scroll del body
        }

        // Función para ocultar el modal
        function hideModal() {
            document.getElementById('modal-verPerfil').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaura el scroll del body
        }

        // Función para cerrar el dropdown activo
        function closeActiveDropdowns() {
            // Cerrar el dropdown al abrir el modal
            const activeDropdowns = document.querySelectorAll('.dropdown-menu.active');
            activeDropdowns.forEach(dropdown => {
                dropdown.classList.remove('active');
            });

            const activeButtons = document.querySelectorAll('.expand-btn.active');
            activeButtons.forEach(button => {
                button.classList.remove('active');
            });
        }

        // --- CONFIGURACIÓN DEL BOTÓN "VER PERFIL" ---

        // Seleccionar todos los menús desplegables
        const dropdownMenus = document.querySelectorAll('.dropdown-menu');

        dropdownMenus.forEach(menu => {
            // Seleccionar el primer elemento (Ver Perfil) en cada menú desplegable
            const verPerfilItem = menu.querySelector('.dropdown-item:nth-child(1)');

            if (verPerfilItem) {
                verPerfilItem.addEventListener('click', function (e) {
                    e.stopPropagation(); // Evita que el click se propague
                    showModal();
                    closeActiveDropdowns();
                });
            }
        });

        // --- CONFIGURACIÓN PARA CERRAR EL MODAL ---

        // Cerrar modal con botón de Cancelar
        const cancelButton = document.querySelector('.cancel-button');
        if (cancelButton) {
            cancelButton.addEventListener('click', hideModal);
        }


        // Cerrar modal al hacer clic en el overlay
        const modalOverlay = document.querySelector('.modal-overlay');
        if (modalOverlay) {
            modalOverlay.addEventListener('click', hideModal);
        }

        // Evitar que al hacer clic en el contenido del modal, este se cierre
        const modalContent = document.querySelector('.modal-content');
        if (modalContent) {
            modalContent.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }
    });


    document.addEventListener('DOMContentLoaded', function () {
        // Manejar clic en los botones de expansión
        document.querySelectorAll('.expand-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.stopPropagation();

                // Cerrar otros dropdowns abiertos
                document.querySelectorAll('.expand-btn').forEach(btn => {
                    if (btn !== this) {
                        btn.classList.remove('active');
                        const menu = btn.nextElementSibling;
                        if (menu && menu.classList.contains('dropdown-menu')) {
                            menu.classList.remove('active');
                        }
                        // Remover clase menu-active del contenedor
                        const container = btn.closest('.dropdown-container');
                        if (container) {
                            container.classList.remove('menu-active');
                        }
                    }
                });

                // Toggle el dropdown actual
                this.classList.toggle('active');
                const dropdownMenu = this.nextElementSibling;
                if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
                    dropdownMenu.classList.toggle('active');

                    // Añadir o remover clase menu-active al contenedor
                    const container = this.closest('.dropdown-container');
                    if (container) {
                        if (dropdownMenu.classList.contains('active')) {
                            container.classList.add('menu-active');
                        } else {
                            container.classList.remove('menu-active');
                        }
                    }
                }
            });
        });

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function () {
            document.querySelectorAll('.expand-btn.active').forEach(btn => {
                btn.classList.remove('active');
                const menu = btn.nextElementSibling;
                if (menu && menu.classList.contains('dropdown-menu')) {
                    menu.classList.remove('active');
                }
                // Remover clase menu-active del contenedor
                const container = btn.closest('.dropdown-container');
                if (container) {
                    container.classList.remove('menu-active');
                }
            });
        });

        // Manejar clic en las opciones del dropdown
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function (e) {
                e.stopPropagation();

                // Marcar la opción seleccionada
                const parentMenu = this.closest('.dropdown-menu');
                parentMenu.querySelectorAll('.dropdown-item').forEach(menuItem => {
                    menuItem.classList.remove('active');
                });
                this.classList.add('active');

                // Aquí puedes añadir la lógica para cada opción
                const action = this.querySelector('span').textContent;
                console.log(`Acción seleccionada: ${action}`);

                // Cerrar el dropdown después de seleccionar
                const expandButton = parentMenu.previousElementSibling;
                if (expandButton && expandButton.classList.contains('expand-btn')) {
                    expandButton.classList.remove('active');
                    parentMenu.classList.remove('active');

                    // Remover clase menu-active del contenedor
                    const container = expandButton.closest('.dropdown-container');
                    if (container) {
                        container.classList.remove('menu-active');
                    }
                }
            });
        });
    });

    // Script para el menú de perfil
    document.querySelector('.perfil-flecha').addEventListener('click', function () {
        const perfilMenu = document.getElementById('perfilMenu');
        perfilMenu.classList.toggle('show-menu');
    });

    // Cerrar el menú al hacer clic fuera de él
    document.addEventListener('click', function (event) {
        const perfilMenu = document.getElementById('perfilMenu');
        const perfilFlecha = document.querySelector('.perfil-flecha');

        // Si el clic no fue en el menú ni en el botón de la flecha, cerrar el menú
        if (!perfilMenu.contains(event.target) && !perfilFlecha.contains(event.target)) {
            perfilMenu.classList.remove('show-menu');
        }
    });

    // Script para los menús desplegables de navegación
    document.querySelectorAll('.main-button').forEach(button => {
        button.addEventListener('click', (event) => {
            // Evitar que se cierre el sidebar si solo estamos desplegando submenu
            event.stopPropagation();

            const parent = button.parentElement;
            const wasActive = parent.classList.contains('active');

            // Cerrar todos los menús activos
            document.querySelectorAll('.menu-item.active').forEach(item => {
                item.classList.remove('active');
            });

            // Si no estaba activo, activarlo
            if (!wasActive) {
                parent.classList.add('active');
            }
        });
    });

    // Script para toggle del sidebar en móviles
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');
    const overlay = document.getElementById('sidebarOverlay');

    sidebarToggle.addEventListener('click', function () {
        sidebar.classList.toggle('open');
        hamburger.classList.toggle('open');
        overlay.classList.toggle('active');

        // Mover el botón también cuando el sidebar está abierto
        sidebarToggle.classList.toggle('moved');
    });

    // Cerrar sidebar al hacer clic en el overlay
    overlay.addEventListener('click', function () {
        sidebar.classList.remove('open');
        hamburger.classList.remove('open');
        overlay.classList.remove('active');
        sidebarToggle.classList.remove('moved'); // Regresar el botón a su posición original
    });

    // Cerrar sidebar SOLO cuando se hace clic en enlaces de navegación
    document.querySelectorAll('.nav-link').forEach(item => {
        item.addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('open');
                hamburger.classList.remove('open');
                overlay.classList.remove('active');
                sidebarToggle.classList.remove('moved'); // Regresar el botón a su posición original
            }
        });
    });

    // Ajustar al cambiar el tamaño de la ventana
    window.addEventListener('resize', function () {
        if (window.innerWidth > 768) {
            sidebar.classList.remove('open');
            hamburger.classList.remove('open');
            overlay.classList.remove('active');
            sidebarToggle.classList.remove('moved'); // Regresar el botón a su posición original
        }
    });
</script>
<script th:if="${message != null}">
    window.onload = function () {
        showSimpleNotification("[[${message}]]", "[[${type}]]");
    }

</script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // Verificar si hay un parámetro "cancelado" en la URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('cancelado')) {
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const inputBusqueda = document.querySelector(".filter-search");
        const botonLimpiar = document.querySelector(".search-btn");


        inputBusqueda.addEventListener("input", filtrarMiembros);
        botonLimpiar.addEventListener("click", (e) => {
            e.preventDefault(); // Evita recarga si está dentro de un <form>
            inputBusqueda.value = ""; // Limpia el campo
            filtrarMiembros(); // Muestra todos
        });
    });

    function filtrarMiembros() {
        const filtro = document.querySelector(".filter-search").value.toLowerCase();
        const filas = document.querySelectorAll("#tablaMiembros tr");

        filas.forEach(fila => {
            const spanNombre = fila.querySelector(".user-container span");
            if (spanNombre) {
                const nombreCompleto = spanNombre.innerText.toLowerCase();
                fila.style.display = (nombreCompleto.includes(filtro) || filtro.trim() === "") ? "" : "none";
            }
        });
    }
</script>
</body>
</html>