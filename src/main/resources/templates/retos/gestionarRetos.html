<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Retos</title>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/style/retosStyle.css}">
    <link rel="stylesheet" th:href="@{/style/notification.css}">
    <script th:src="@{/js/notification.js}"></script>
</head>
<body>
<!-- Botón hamburguesa para móviles -->
<button class="sidebar-toggle" id="sidebarToggle">
    <div class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>
</button>

<!-- Overlay para fondos oscuros al abrir sidebar en móvil -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div th:include="admin/template_admin.html::header"></div>


<!-- Contenido principal -->
<main>

    <div class="container">
        <div class="header">
            <h1 class="encabezado">Retos y Etapas de Progresión</h1>
            <p class="description">Desde aquí puedes crear, editar y administrar los retos de cada etapa según la rama
                del grupo scout.</p>
        </div>


        <div class="divider-line"></div>

        <div id="retosSection" class="controls">
            <div class="tabs">
                <a th:each="etapa : ${etapas}"
                   th:href="@{'/progresiones?etapaSeleccionada=' + ${etapa.nombre}}"
                   th:classappend="${etapa.nombre == etapaSeleccionada} ? 'active'" class="tab-button">
                    <span th:text="${etapa.nombre}"></span>
                </a>
            </div>
            <button class="create-reto-btn">
                <span>Nuevo Reto</span>
                <img src="./img/plus.svg" alt="Arrow" width="16" height="16">
            </button>
        </div>

        <div th:each="etapa : ${etapas}"
             th:href="@{/progresiones(etapaSeleccionada=${etapa.nombre})}"
             th:classappend="${etapa.nombre == etapaSeleccionada} ? 'content-area active' : 'content-area'">
            <table>
                <thead>
                <tr>
                    <th style="text-align: center">#</th>
                    <th style="text-align: center">Descripción</th>
                    <th style="text-align: center">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="reto : ${retos}"
                    th:if="${reto.etapa.nombre == etapa.nombre}" th:object="${reto}">
                    <td class="number-colm" th:text="${reto.numero}"></td>
                    <td th:text="${reto.descripcion}"></td>
                    <td class="action-col">
                        <div class="dropdown-container">
                            <button class="expand-btn">
                                <div class="dots-container">
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                    <div class="dot"></div>
                                </div>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item">
                                    <img th:src="@{/img/modify.svg}" alt="Modificar" class="dropdown-icon">
                                    <span>Modificar</span>
                                </div>
                                <div class="dropdown-item">
                                    <img th:src="@{/img/trash.svg}" alt="Eliminar" class="dropdown-icon">
                                    <span>Eliminar</span>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="pagination-container">
            <div class="pagination">
                <a class="pagination-btn" id="prevPage" style="display: none;">Anterior</a>
                <span class="pagination-info" id="pageInfo"></span>
                <a class="pagination-btn" id="nextPage" style="display: none;">Siguiente</a>
            </div>
        </div>
    </div>

    <!-- Modal de Crear Retos -->
    <form id="formularioReto" th:action="@{/retos/registrar}" method="post">
        <div id="modal-crearReto" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Crear Nuevo Reto</h2>
                    <p>Aquí puedes registrar un nuevo reto correspondiente a una etapa de progresión. Asegúrate de que
                        sea
                        claro, alcanzable y esté alineado con los objetivos de la rama.</p>
                    <p style="margin-top: 12px;">Este reto será visible para todos los miembros de la etapa
                        seleccionada.</p>
                </div>

                <div class="section">
                    <h2 class="section-title">Información del Reto</h2>
                    <p class="section-subtitle">Datos básicos sobre el reto.</p>

                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 185px; max-width: 185px;">
                            <label for="numero">Numero del Reto</label>
                            <input type="number" id="numero" name="numero" placeholder="Ingresa el número..." required
                                   min="1">
                        </div>

                        <div class="form-group">
                            <label for="etapa">Etapa a la que está dirigido</label>
                            <select id="etapa" name="etapa" required>
                                <option value="" disabled selected>Selecciona la Etapa...</option>
                                <option th:each="etapa : ${etapas}"
                                        th:value="${etapa.nombre}"
                                        th:text="${etapa.nombre}">
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="descripcion">Descripción del Reto</label>
                            <textarea id="descripcion" name="descripcion"
                                      placeholder="Ingresa aquí la descripción del Reto..." required></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="botones btn-secondary cancel-button">Cancelar</button>
                    <button type="submit" class="botones btn-primary save-button">Guardar</button>
                </div>
            </div>
            <div class="modal-overlay"></div>
        </div>
    </form>

    <!-- Modal de Modificar Retos -->
    <div id="modal-modificarReto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modificar Reto</h2>
                <p>Aquí puedes la información de un reto correspondiente a una etapa de progresión. Asegúrate de que sea
                    claro, alcanzable y esté alineado con los objetivos de la rama.</p>
                <p style="margin-top: 12px;">Este reto será visible para todos los miembros de la etapa
                    seleccionada.</p>
            </div>
            <div class="section">
                <h2 class="section-title">Información del Reto</h2>
                <p class="section-subtitle">Datos básicos sobre el reto.</p>

                <!-- Ambos campos en la misma fila -->
                <div class="form-row">
                    <div class="form-group" style="flex: 0 0 185px; max-width: 185px;">
                        <label for="challenge-number">Numero del Reto</label>
                        <input type="text" id="challenge-number" placeholder="Ingresa el número...">
                    </div>

                    <div class="form-group">
                        <label for="activity-branch">Etapa a la que esta dirigida</label>
                        <select id="activity-branch">
                            <option value="" disabled selected>Selecciona la Etapa...</option>
                            <option value="rama1">Rama 1</option>
                            <option value="rama2">Rama 2</option>
                            <option value="rama3">Rama 3</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="activity-description">Descripcion del Reto</label>
                        <textarea id="activity-description"
                                  placeholder="Ingresa aquí la descripción de la actividad..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="botones btn-secondary cancel-button">Cancelar</button>
                <button class="botones btn-primary save-button">Guardar</button>
            </div>
        </div>
        <div class="modal-overlay"></div>
    </div>

    </div>

    <div th:include="admin/template_admin.html::footer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const rowsPerPage = 10;
            const table = document.querySelector('table tbody');
            const rows = Array.from(table.querySelectorAll('tr'));
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');
            const paginationContainer = document.querySelector('.pagination-container'); // Agregamos
            const retosSection = document.getElementById('retosSection');
            let currentPage = 1;
            const totalPages = Math.ceil(rows.length / rowsPerPage);

            function renderTablePage(page) {
                table.innerHTML = '';
                const start = (page - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                rows.slice(start, end).forEach(row => {
                    table.appendChild(row);
                });

                // Mostrar solo si hay más de una página
                if (totalPages > 1) {
                    paginationContainer.style.display = 'flex';
                    pageInfo.textContent = `Página ${page} de ${totalPages}`;
                    prevButton.style.display = page > 1 ? 'inline-block' : 'none';
                    nextButton.style.display = page < totalPages ? 'inline-block' : 'none';
                } else {
                    paginationContainer.style.display = 'none'; // Ocultamos todo si solo hay una página
                }
            }

            prevButton.addEventListener('click', function () {
                if (currentPage > 1) {
                    currentPage--;
                    renderTablePage(currentPage);
                    retosSection.scrollIntoView({behavior: 'smooth'});
                }
            });

            nextButton.addEventListener('click', function () {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTablePage(currentPage);
                    retosSection.scrollIntoView({behavior: 'smooth'});
                }
            });

            renderTablePage(currentPage);
        });
    </script>


</main>

<script th:if="${message != null}">
    window.onload = function () {
        showSimpleNotification("[[${message}]]", "[[${type}]]");
    }
</script>

<!-- JavaScript para la funcionalidad de los modales-->
<script>

    document.addEventListener('DOMContentLoaded', function () {
        // --- FUNCIONES COMPARTIDAS ---
        // Función genérica para mostrar un modal
        function showModalById(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden'; // Evita el scroll del body
        }

        // Función genérica para ocultar un modal
        function hideModalById(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaura el scroll del body
        }

        // --- MODAL CREAR RETO ---
        const crearRetoModal = document.getElementById('modal-crearReto');
        if (crearRetoModal) {
            // Botón "Nuevo Reto" - Abre el modal de crear reto
            const createRetoBtn = document.querySelector('.create-reto-btn');
            if (createRetoBtn) {
                createRetoBtn.addEventListener('click', function () {
                    showModalById('modal-crearReto');
                });
            }

            // Configuración para cerrar el modal crear reto
            const cancelButtonCrear = crearRetoModal.querySelector('.cancel-button');
            if (cancelButtonCrear) {
                cancelButtonCrear.addEventListener('click', function () {
                    document.getElementById('formularioReto').reset();
                    hideModalById('modal-crearReto');
                });
            }

            // Botón guardar del modal crear reto
            const saveButtonCrear = crearRetoModal.querySelector('.save-button');
            const form = crearRetoModal.querySelector('form'); // Obtener el formulario

            if (saveButtonCrear) {
                saveButtonCrear.addEventListener('click', function (event) {
                    // Evitar el cierre del modal y el envío si el formulario no es válido
                    if (!form.checkValidity()) {
                        event.preventDefault(); // Prevenir el envío
                        alert("Por favor, rellene todos los campos obligatorios."); // Alerta de advertencia
                    } else {
                        // Si el formulario es válido, puedes realizar el envío o el proceso correspondiente
                        hideModalById('modal-crearReto');
                        // Aquí puedes agregar la lógica para guardar los datos del reto
                    }
                });
            }

            // Cerrar al hacer click en el overlay
            const overlayCrear = crearRetoModal.querySelector('.modal-overlay');
            if (overlayCrear) {
                overlayCrear.addEventListener('click', function () {
                    hideModalById('modal-crearReto');
                });
            }

            // Evitar cierre al hacer click en el contenido
            const contentCrear = crearRetoModal.querySelector('.modal-content');
            if (contentCrear) {
                contentCrear.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            }
        }

        // --- MODAL MODIFICAR RETO ---
        const modificarRetoModal = document.getElementById('modal-modificarReto');
        if (modificarRetoModal) {
            // Botón cancelar del modal modificar reto
            const cancelButtonModificar = modificarRetoModal.querySelector('.cancel-button');
            if (cancelButtonModificar) {
                cancelButtonModificar.addEventListener('click', function () {
                    hideModalById('modal-modificarReto');
                });
            }

            // Botón guardar del modal modificar reto
            const saveButtonModificar = modificarRetoModal.querySelector('.save-button');
            if (saveButtonModificar) {
                saveButtonModificar.addEventListener('click', function () {
                    hideModalById('modal-modificarReto');
                    // Aquí puedes agregar la lógica para guardar los datos modificados
                });
            }

            // Cerrar al hacer click en el overlay
            const overlayModificar = modificarRetoModal.querySelector('.modal-overlay');
            if (overlayModificar) {
                overlayModificar.addEventListener('click', function () {
                    hideModalById('modal-modificarReto');
                });
            }

            // Evitar cierre al hacer click en el contenido
            const contentModificar = modificarRetoModal.querySelector('.modal-content');
            if (contentModificar) {
                contentModificar.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            }
        }

        // --- FUNCIONES PARA MENÚ Y SIDEBAR ---
        // Manejar clic en los botones de expansión
        document.querySelectorAll('.expand-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.stopPropagation();

                // Cerrar otros dropdowns abiertos
                document.querySelectorAll('.expand-btn').forEach(btn => {
                    if (btn !== this) {
                        btn.classList.remove('active');
                        const menu = btn.nextElementSibling;
                        if (menu && menu.classList.contains('dropdown-menu')) {
                            menu.classList.remove('active');
                        }
                        // Remover clase menu-active del contenedor
                        const container = btn.closest('.dropdown-container');
                        if (container) {
                            container.classList.remove('menu-active');
                        }
                    }
                });

                // Toggle el dropdown actual
                this.classList.toggle('active');
                const dropdownMenu = this.nextElementSibling;
                if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
                    dropdownMenu.classList.toggle('active');

                    // Añadir o remover clase menu-active al contenedor
                    const container = this.closest('.dropdown-container');
                    if (container) {
                        if (dropdownMenu.classList.contains('active')) {
                            container.classList.add('menu-active');
                        } else {
                            container.classList.remove('menu-active');
                        }
                    }
                }
            });
        });

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function () {
            document.querySelectorAll('.expand-btn.active').forEach(btn => {
                btn.classList.remove('active');
                const menu = btn.nextElementSibling;
                if (menu && menu.classList.contains('dropdown-menu')) {
                    menu.classList.remove('active');
                }
                // Remover clase menu-active del contenedor
                const container = btn.closest('.dropdown-container');
                if (container) {
                    container.classList.remove('menu-active');
                }
            });
        });

        // Manejar clic en las opciones del dropdown
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', function (e) {
                e.stopPropagation();

                // Marcar la opción seleccionada
                const parentMenu = this.closest('.dropdown-menu');
                parentMenu.querySelectorAll('.dropdown-item').forEach(menuItem => {
                    menuItem.classList.remove('active');
                });
                this.classList.add('active');

                // Aquí puedes añadir la lógica para cada opción
                const action = this.querySelector('span').textContent;
                console.log(`Acción seleccionada: ${action}`);

                // Cerrar el dropdown después de seleccionar
                const expandButton = parentMenu.previousElementSibling;
                if (expandButton && expandButton.classList.contains('expand-btn')) {
                    expandButton.classList.remove('active');
                    parentMenu.classList.remove('active');

                    // Remover clase menu-active del contenedor
                    const container = expandButton.closest('.dropdown-container');
                    if (container) {
                        container.classList.remove('menu-active');
                    }
                }
            });
        });

        // Script para el menú de perfil
        document.querySelector('.perfil-flecha').addEventListener('click', function () {
            const perfilMenu = document.getElementById('perfilMenu');
            perfilMenu.classList.toggle('show-menu');
        });

        // Cerrar el menú al hacer clic fuera de él
        document.addEventListener('click', function (event) {
            const perfilMenu = document.getElementById('perfilMenu');
            const perfilFlecha = document.querySelector('.perfil-flecha');

            // Si el clic no fue en el menú ni en el botón de la flecha, cerrar el menú
            if (!perfilMenu.contains(event.target) && !perfilFlecha.contains(event.target)) {
                perfilMenu.classList.remove('show-menu');
            }
        });

        // Script para los menús desplegables de navegación
        document.querySelectorAll('.main-button').forEach(button => {
            button.addEventListener('click', (event) => {
                // Evitar que se cierre el sidebar si solo estamos desplegando submenu
                event.stopPropagation();

                const parent = button.parentElement;
                const wasActive = parent.classList.contains('active');

                // Cerrar todos los menús activos
                document.querySelectorAll('.menu-item.active').forEach(item => {
                    item.classList.remove('active');
                });

                // Si no estaba activo, activarlo
                if (!wasActive) {
                    parent.classList.add('active');
                }
            });
        });

        // Script para toggle del sidebar en móviles
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.getElementById('hamburger');
        const overlay = document.getElementById('sidebarOverlay');

        sidebarToggle.addEventListener('click', function () {
            sidebar.classList.toggle('open');
            hamburger.classList.toggle('open');
            overlay.classList.toggle('active');

            // Mover el botón también cuando el sidebar está abierto
            sidebarToggle.classList.toggle('moved');
        });

        // Cerrar sidebar al hacer clic en el overlay
        overlay.addEventListener('click', function () {
            sidebar.classList.remove('open');
            hamburger.classList.remove('open');
            overlay.classList.remove('active');
            sidebarToggle.classList.remove('moved'); // Regresar el botón a su posición original
        });

        // Cerrar sidebar SOLO cuando se hace clic en enlaces de navegación
        document.querySelectorAll('.nav-link').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('open');
                    hamburger.classList.remove('open');
                    overlay.classList.remove('active');
                    sidebarToggle.classList.remove('moved'); // Regresar el botón a su posición original
                }
            });
        });

        // Ajustar al cambiar el tamaño de la ventana
        window.addEventListener('resize', function () {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                hamburger.classList.remove('open');
                overlay.classList.remove('active');
                sidebarToggle.classList.remove('moved'); // Regresar el botón a su posición original
            }
        });
    });

</script>
</body>
</html>